name: Build Windows Setup

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Get packages
        run: flutter pub get

      - name: Build Windows App
        run: flutter build windows --release

      # Install Inno Setup
      - name: Install Inno Setup
        run: choco install innosetup -y

      # Create installer.iss with correct app name
      - name: Create ISS file
        shell: cmd
        run: |
          (
          echo [Setup]
          echo AppName=Anigen
          echo AppVersion=1.0.0
          echo AppPublisher=Anigen
          echo DefaultDirName={autopf}\Anigen
          echo DefaultGroupName=Anigen
          echo OutputDir=installer
          echo OutputBaseFilename=Anigen-Setup-Windows
          echo Compression=lzma2
          echo SolidCompression=yes
          echo.
          echo [Files]
          echo Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: recursesubdirs
          echo.
          echo [Icons]
          echo Name: "{group}\Anigen"; Filename: "{app}\anigen.exe"
          echo Name: "{autodesktop}\Anigen"; Filename: "{app}\anigen.exe"
          echo.
          echo [Run]
          echo Filename: "{app}\anigen.exe"; Description: "Launch Anigen"; Flags: nowait postinstall skipifsilent
          ) > installer.iss

      - name: Build Installer
        run: iscc installer.iss

      - name: Upload Setup
        uses: actions/upload-artifact@v4
        with:
          name: Anigen-Windows-Setup
          path: installer/Anigen-Setup-Windows.exe
