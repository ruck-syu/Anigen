name: Build Windows Setup

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Get packages
        run: flutter pub get

      # Convert icon.png to .ico and replace Windows app icon
      - name: Install ImageMagick
        run: choco install imagemagick -y

      - name: Convert and replace app icon
        run: |
          magick assets/icon.png -define icon:auto-resize=256,128,64,48,32,16 windows/runner/resources/app_icon.ico

      - name: Build Windows App
        run: flutter build windows --release

      # Install Inno Setup
      - name: Install Inno Setup
        run: choco install innosetup -y

      # Create installer.iss with correct app name
      - name: Create ISS file
        shell: cmd
        run: |
          (
          echo [Setup]
          echo AppName=Anigen
          echo AppVersion=1.0.0
          echo AppPublisher=Anigen
          echo DefaultDirName={autopf}\Anigen
          echo DefaultGroupName=Anigen
          echo OutputDir=installer
          echo OutputBaseFilename=Anigen-Setup-Windows
          echo Compression=lzma2
          echo SolidCompression=yes
          echo.
          echo [Files]
          echo Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: recursesubdirs
          echo Source: "assets\icon.png"; DestDir: "{app}"; Flags: ignoreversion
          echo.
          echo [Icons]
          echo Name: "{group}\Anigen"; Filename: "{app}\anigen.exe"
          echo Name: "{autodesktop}\Anigen"; Filename: "{app}\anigen.exe"
          echo.
          echo [Run]
          echo Filename: "{app}\anigen.exe"; Description: "Launch Anigen"; Flags: nowait postinstall skipifsilent
          echo.
          echo ; Check and prompt for VC++ Redistributable
          echo [Code]
          echo function VCRedistNeedsInstall: Boolean;
          echo begin
          echo   Result := not RegKeyExists(HKLM, 'SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64'^);
          echo end;
          echo.
          echo function InitializeSetup: Boolean;
          echo begin
          echo   Result := True;
          echo   if VCRedistNeedsInstall then
          echo   begin
          echo     MsgBox('This application requires Visual C++ Redistributable. Please install it from Microsoft if the app does not work.', mbInformation, MB_OK^);
          echo   end;
          echo end;
          ) > installer.iss

      - name: Build Installer
        run: iscc installer.iss

      - name: Upload Setup
        uses: actions/upload-artifact@v4
        with:
          name: Anigen-Windows-Setup
          path: installer/Anigen-Setup-Windows.exe
